---
title: "Project PTDS"
author: "Luca Bron, David Germano, Patrik Grandadam, Vincent Lomazzi, Edgar Raisin"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    theme: cerulean
    highlight: tango
---

```{r}
library(robotstxt)
library(xml2)
library(rvest)
library(magrittr)
library(stringr)
library(dplyr)
library(plotly)
library(ggmap)
```


# Webscrapping

Example data structure de Iegor a rearranger

```{r}
cities <- list(
  zurich = list(),
  geneve = list(),
  basel = list(),
  lausanne = list(),
  bern = list(),
  winterthur = list(),
  lucerne = list(),
  lugano = list()
  )
# 
# list(
#    zurich = list(page1 = c(12, 12, 1213),
#      page2 = c(1222, 12, 1213)),
#    geneva = list()
# )
# 
# 
#  # lausanne
# page1 <- c(12, 13, 14)
# attr(x = page1, which = "url") <- "http..."
# 
# 
# page2 <- c(11, 13, 14)
# attr(x = prices$zurich$page2, which = "url") <- "http...2"
# 
# prices <- list(
#   lausanne = list(page1, page2),
#   basel = list(page1, page2)
# )
# 
# prices
```


Cities of interest.

```{r}
# cities2 <- c("Zurich", "Geneve", "Basel", "Lausanne", "Bern",
#             "Winterthur", "Lucerne", "Lugano")
```


## Immoscout

Is the path allowed for each city? 

```{r, eval = FALSE}
paths_allowed(paste(paths="/en/real-estate/rent/city/", cities, sep=""),
              domain="https://www.immoscout24.ch")
get_robotstxt(domain="https://www.immoscout24.ch")
```
--> Yes 


LOOPING OVER EACH CITY

Getting the URL of each cities in new variables linked to each of them:

```{r}
# for (i in 1:length(cities2)){
# assign(paste("url_immoscout_", cities2[i], sep=""), paste("https://www.immoscout24.ch/en/real-estate/rent/city-", cities2[i], sep=""))
#   }
```

```{r}
for (i in 1:length(cities)){
  attr(cities[[i]], which="url") <- paste(
    "https://www.immoscout24.ch/en/real-estate/rent/city-", 
    names(cities[i]), sep="") 
}
```

```{r}
pages <- list()
for( i in 1:length(cities)){
  pages[[i]] <- read_html(x = paste0(unlist(attributes(cities[[i]]), 
                                            use.names = FALSE))) %>%
    html_nodes(css = ".cXTlXt") %>%
    html_text() %>%
    as.numeric() %>%
    max(na.rm = TRUE) %>%
    subtract(e2 = 1) %>%
    seq(from = 1) 
}
```

Looping over cities and pages to get all prices for all cities
```{r}
# for (i in 1:length(cities2)){
#   for (page in paste("pages_immoscout_", cities2[i], sep="") %>% get){
#     url_path_page_immoscout <-
#       paste("https://www.immoscout24.ch/en/real-estate/rent/city-",
#       cities2[i], sep="") %>% 
#     paste("?pn=", page, sep="")
# 
# ## doesnt work...
# assign(paste("prices_immoscout_", cities2[i], sep="") %>% paste("_page_", page, sep=""), read_html(url_path_page_immoscout) %>% 
#   html_nodes(".fFoWRd") %>%
#   html_text())
#   }
# }
```

Getting the prices with the "Selector Gadget":

```{r}
# .fFoWRd --> the prices
# .kEhyoM .ehLwuE --> the nb of rooms and the surface
# .gDVamO .fUZwLT --> the address
# .gDVamO .fUZwLT , .kEhyoM .ehLwuE, .fFoWRd --> all combined without other perturbating lements
# .csgoYM --> the big box
```

Scrapping everything at once:
```{r}
for (i in 1:length(cities)){
  for (page in pages[[i]]){  
    url_path_page_immoscout <- cities[[i]] %>% 
      attributes %>% 
      unlist(use.names = FALSE) %>% 
      paste0 %>%
      paste("?pn=", page, sep="") 
    
    cities[[i]][[page]] <- list()
    cities[[i]][[page]] <- read_html(url_path_page_immoscout) %>% 
      html_nodes(".csgoYM") %>%
      html_text()
  }
}

## Code to test if working on the last page of Lugano
# a <- read_html(url_path_page_immoscout) %>% 
#   html_nodes(".csgoYM") %>%
#   html_text() %>%
#   gsub("\u00B2","",.) %>% 
#   gsub(".\u2014","",.) %>% data.frame


```

Creating one big dataframe with all values of all cities to be used later (not cleaned yet) 
```{r}
unlisted_cities <- unlist(cities) %>% data.frame
```



Iegor's code
```{r}
item_full_info <- read_html(
  "https://www.immoscout24.ch/en/real-estate/rent/city-lausanne?pn=1") %>%
  html_nodes(".csgoYM") %>%
  html_text()
# 
# # Code to see the structure of the data once unlisted
# unlisted_cities <- unlist(cities) %>% data.frame
# 
# geneve <- unlisted_cities[grep('^geneve', rownames(unlisted_cities)),] 
# item_full_info <- geneve
# 
# # Code to see if everything works fine
# my_test <- data.frame(
#   # Extract number of rooms
#   rooms = str_extract(item_full_info, ".*m\u00B2") %>%
#              str_extract(., ".*rooms*") %>%
#              gsub(pattern = " rooms", replacement = "", fixed = TRUE) %>%
#              gsub(pattern = " room", replacement = "", fixed = TRUE),
# 
#            # Extract Size
#            m2 = str_extract(item_full_info, ".*m\u00B2\u00AB") %>%
#              str_extract(., ", .*") %>%
#              gsub(pattern=" m\u00B2\u00AB", replacement = "", fixed = TRUE) %>%
#              gsub(pattern= ", ", replacement = "", fixed = TRUE),
#            
#            #extract price
#            price = str_extract(item_full_info, "eCHF .*") %>% str_extract(., ".*.\u2014 *") %>%
#              gsub(pattern = "eCHF ", replacement = "", fixed = TRUE) %>%
#              gsub(pattern = ".\u2014", replacement = "", fixed = TRUE) %>%
#              gsub(pattern = ",", replacement = "", fixed = TRUE),
# 
#            # Extract localiation
#            address =  str_extract(item_full_info, ".*Close") %>%
#              str_extract(., ".*,") %>%
#              str_extract(., "\u00bb.*") %>%
#              gsub(pattern = "Close", replacement = "", fixed = TRUE) %>%
#              gsub(pattern = ",", replacement = "", fixed = TRUE) %>%
#              gsub(pattern = "\u00bb", replacement = "", fixed = TRUE) %>%
#              gsub(pattern = "\u00FC", replacement = "u", fixed = TRUE) %>%
#              gsub(pattern = "\u00E4", replacement = "a", fixed = TRUE) %>%
#              gsub(pattern = "\u00F6", replacement = "o", fixed = TRUE) %>%
#              gsub(pattern = "\u00E8", replacement = "e", fixed = TRUE) %>%
#              gsub(pattern = "\u00E9", replacement = "e", fixed = TRUE) %>%
#              gsub(pattern = "\u00EA", replacement = "e", fixed = TRUE) %>%
#              gsub(pattern = "\u00F4", replacement = "o", fixed = TRUE) %>%
#              gsub(pattern = "\u00EF", replacement = "i", fixed = TRUE) %>%
#              gsub(pattern = "\u00EB", replacement = "e", fixed = TRUE) %>%
#              gsub(pattern = "\u00EE", replacement = "e", fixed = TRUE) %>%
#              gsub(pattern = "\u00E7", replacement = "c", fixed = TRUE) %>%
#              gsub(pattern = "\u00E2", replacement = "a", fixed = TRUE) 
#            ,
#            
#            # Assign the city
#            postcode = str_extract(item_full_info, ".*Close") %>%
#              str_extract(., ".*,") %>%
#              str_extract(., "\u00bb.*") %>%
#              gsub(pattern = "Close", replacement = "", fixed = TRUE) %>%
#              gsub(pattern = ",", replacement = "", fixed = TRUE) %>% 
#              gsub(pattern = "\u00bb", replacement = "", fixed = TRUE) %>%
#              word(., -2),
#            
#            city = str_extract(item_full_info, ".*Close") %>%
#              str_extract(., ".*,") %>%
#              str_extract(., "\u00bb.*") %>%
#              gsub(pattern = "Close", replacement = "", fixed = TRUE) %>%
#              gsub(pattern = ",", replacement = "", fixed = TRUE) %>% 
#              gsub(pattern = "\u00bb", replacement = "", fixed = TRUE) %>%
#              word(., -1)
#          )
```

Creating a dataframe for each city

```{r}
# for (i in 1:length(cities)){
#   item_full_info <- unlisted_cities[grep(names(cities[i]), rownames(unlisted_cities)),]
#   #extract number of rooms
# 
#   assign(paste("df_", names(cities[i]), sep=""),
#          data.frame(
#            rooms = str_extract(item_full_info, ".*\u00AB") %>%
#              # first taking before m2 for the cases where the word "room" or "rooms"
#              # is mentionned in the description
#              str_extract(., ".*room") %>%
#              gsub(pattern = " room", replacement = "", fixed = TRUE) %>%
#              as.numeric
#            ,
# 
#            # Extract Size
#            m2 = str_extract(item_full_info, ".*m\u00B2\u00AB") %>%
#              gsub(pattern=" m\u00B2\u00AB", replacement = "", fixed = TRUE) %>%
#              word(.,-1) %>%
#              as.integer
#            ,
# 
#            #extract price
#            price = str_extract(item_full_info, "eCHF .*") %>% str_extract(., ".*.\u2014 *") %>%
#              gsub(pattern = "eCHF ", replacement = "", fixed = TRUE) %>%
#              gsub(pattern = ".\u2014", replacement = "", fixed = TRUE) %>%
#              gsub(pattern = ",", replacement = "", fixed = TRUE) %>% as.integer
#            ,
# 
#            # Extract localiation
#            address =  str_extract(item_full_info, ".*Close") %>%
#              str_extract(., ".*,") %>%
#              str_extract(., "\u00bb.*") %>%
#              gsub(pattern = "Close", replacement = "", fixed = TRUE) %>%
#              gsub(pattern = ",", replacement = "", fixed = TRUE) %>%
#              gsub(pattern = "\u00bb", replacement = "", fixed = TRUE) %>%
#              gsub(pattern = "\u00FC", replacement = "u", fixed = TRUE) %>%
#              gsub(pattern = "\u00E4", replacement = "a", fixed = TRUE) %>%
#              gsub(pattern = "\u00F6", replacement = "o", fixed = TRUE) %>%
#              gsub(pattern = "\u00E8", replacement = "e", fixed = TRUE) %>%
#              gsub(pattern = "\u00E9", replacement = "e", fixed = TRUE) %>%
#              gsub(pattern = "\u00EA", replacement = "e", fixed = TRUE) %>%
#              gsub(pattern = "\u00F4", replacement = "o", fixed = TRUE) %>%
#              gsub(pattern = "\u00EF", replacement = "i", fixed = TRUE) %>%
#              gsub(pattern = "\u00EB", replacement = "e", fixed = TRUE) %>%
#              gsub(pattern = "\u00EE", replacement = "e", fixed = TRUE) %>%
#              gsub(pattern = "\u00E7", replacement = "c", fixed = TRUE) %>%
#              gsub(pattern = "\u00E2", replacement = "a", fixed = TRUE)
#            ,
# 
#            # Assign the city
#            postcode = str_extract(item_full_info, ".*Close") %>%
#              str_extract(., ".*,") %>%
#              str_extract(., "\u00bb.*") %>%
#              gsub(pattern = "Close", replacement = "", fixed = TRUE) %>%
#              gsub(pattern = ",", replacement = "", fixed = TRUE) %>%
#              gsub(pattern = "\u00bb", replacement = "", fixed = TRUE) %>%
#              word(., -2),
# 
#            city = str_extract(item_full_info, ".*Close") %>%
#              str_extract(., ".*,") %>%
#              str_extract(., "\u00bb.*") %>%
#              gsub(pattern = "Close", replacement = "", fixed = TRUE) %>%
#              gsub(pattern = ",", replacement = "", fixed = TRUE) %>%
#              gsub(pattern = "\u00bb", replacement = "", fixed = TRUE) %>%
#              gsub(pattern = "\u00FC", replacement = "u", fixed = TRUE) %>%
#              gsub(pattern = "\u00E8", replacement = "e", fixed = TRUE) %>%
#              word(., -1)
#          )
#   )
# }
```

Getting one big dataframe

```{r}
# combined_df <- rbind(df_basel, 
#                      df_bern, 
#                      df_geneve, 
#                      df_lausanne, 
#                      df_lucerne, 
#                      df_lugano, 
#                      df_winterthur,
#                      df_zurich)
```

```{r}
write.csv(zurich, file = "zurich.csv")
```

Creating a dataframe for each city

Getting only the big dataframe (named all_cities) directly without creating "subdataframes"

```{r}
all_cities <- data.frame()
for (i in 1:length(cities)){
  item_full_info <- unlisted_cities[grep(names(cities[i]), 
                                         rownames(unlisted_cities)),] 
  #extract number of rooms
  

  assign(paste("df_", names(cities[i]), sep=""),  
         data.frame(
           rooms = str_extract(item_full_info, ".*m\u00B2") %>%
             # first taking before m2 for the cases where the word "room" or "rooms" 
             # is mentionned in the description
             str_extract(., ".*rooms*") %>% 
             gsub(pattern = " rooms", replacement = "", fixed = TRUE) %>%
             gsub(pattern = " room", replacement = "", fixed = TRUE) %>% 
             as.numeric
           ,
           
           # Extract Size
           m2 = str_extract(item_full_info, ".*m\u00B2\u00AB") %>%
             str_extract(., ", .*") %>%
             gsub(pattern=" m\u00B2\u00AB", replacement = "", fixed = TRUE) %>%
             gsub(pattern= ", ", replacement = "", fixed = TRUE) 
           %>% as.integer
           ,
           
           # Extract localiation
           address =  str_extract(item_full_info, ".*Close") %>%
             str_extract(., ".*,") %>%
             str_extract(., "\u00bb.*") %>%
             gsub(pattern = "Close", replacement = "", fixed = TRUE) %>%
             gsub(pattern = ",", replacement = "", fixed = TRUE) %>%
             gsub(pattern = "\u00bb", replacement = "", fixed = TRUE) %>%
             gsub(pattern = "\u00FC", replacement = "u", fixed = TRUE) %>%
             gsub(pattern = "\u00E4", replacement = "a", fixed = TRUE) %>%
             gsub(pattern = "\u00F6", replacement = "o", fixed = TRUE) %>%
             gsub(pattern = "\u00E8", replacement = "e", fixed = TRUE) %>%
             gsub(pattern = "\u00E9", replacement = "e", fixed = TRUE) %>%
             gsub(pattern = "\u00EA", replacement = "e", fixed = TRUE) %>%
             gsub(pattern = "\u00F4", replacement = "o", fixed = TRUE) %>%
             gsub(pattern = "\u00EF", replacement = "i", fixed = TRUE)
           ,
           
           #extract price
           price = str_extract(item_full_info, "eCHF .*") %>% str_extract(., ".*.\u2014 *") %>% 
             gsub(pattern = "eCHF ", replacement = "", fixed = TRUE) %>%
             gsub(pattern = ".\u2014", replacement = "", fixed = TRUE) %>%
             gsub(pattern = ",", replacement = "", fixed = TRUE) %>% as.integer
           ,
           
           # Assign the city
           city = names(cities[i])
         )

  city <-  data.frame(
    rooms = str_extract(item_full_info, ".*\u00AB") %>%
      # first taking before m2 for the cases where the word "room" or "rooms" 
      # is mentionned in the description
      str_extract(., ".*room") %>% 
      gsub(pattern = " room", replacement = "", fixed = TRUE) %>% 
      as.numeric
    ,
    
    # Extract Size
    m2 = str_extract(item_full_info, ".*m\u00B2\u00AB") %>%
      # str_extract(., ", .*") %>%
      gsub(pattern=" m\u00B2\u00AB", replacement = "", fixed = TRUE) %>% 
      word(.,-1) %>% 
      as.integer
    ,
    
    #extract price
    price = str_extract(item_full_info, "eCHF .*") %>% 
      str_extract(., ".*.\u2014 *") %>% 
      gsub(pattern = "eCHF ", replacement = "", fixed = TRUE) %>%
      gsub(pattern = ".\u2014", replacement = "", fixed = TRUE) %>%
      gsub(pattern = ",", replacement = "", fixed = TRUE) %>% 
      as.integer
    ,
    
    # Extract localiation
    address =  str_extract(item_full_info, ".*Close") %>%
      str_extract(., ".*,") %>%
      str_extract(., "\u00bb.*") %>%
      gsub(pattern = "Close", replacement = "", fixed = TRUE) %>%
      gsub(pattern = ",", replacement = "", fixed = TRUE) %>%
      gsub(pattern = "\u00bb", replacement = "", fixed = TRUE) %>%
      gsub(pattern = "\u00FC", replacement = "u", fixed = TRUE) %>%
      gsub(pattern = "\u00E4", replacement = "a", fixed = TRUE) %>%
      gsub(pattern = "\u00F6", replacement = "o", fixed = TRUE) %>%
      gsub(pattern = "\u00E8", replacement = "e", fixed = TRUE) %>%
      gsub(pattern = "\u00E9", replacement = "e", fixed = TRUE) %>%
      gsub(pattern = "\u00EA", replacement = "e", fixed = TRUE) %>%
      gsub(pattern = "\u00F4", replacement = "o", fixed = TRUE) %>%
      gsub(pattern = "\u00EF", replacement = "i", fixed = TRUE) %>%
      gsub(pattern = "\u00EB", replacement = "e", fixed = TRUE) %>%
      gsub(pattern = "\u00EE", replacement = "e", fixed = TRUE) %>%
      gsub(pattern = "\u00E7", replacement = "c", fixed = TRUE) %>%
      gsub(pattern = "\u00E2", replacement = "a", fixed = TRUE) 
    ,
    
    postcode = str_extract(item_full_info, ".*Close") %>%
      str_extract(., ".*,") %>%
      str_extract(., "\u00bb.*") %>%
      gsub(pattern = "Close", replacement = "", fixed = TRUE) %>%
      gsub(pattern = ",", replacement = "", fixed = TRUE) %>% 
      gsub(pattern = "\u00bb", replacement = "", fixed = TRUE)  %>%
      word(., -2),
    
    city = str_extract(item_full_info, ".*Close") %>%
      str_extract(., ".*,") %>%
      str_extract(., "\u00bb.*") %>%
      gsub(pattern = "Close", replacement = "", fixed = TRUE) %>%
      gsub(pattern = ",", replacement = "", fixed = TRUE) %>% 
      gsub(pattern = "\u00bb", replacement = "", fixed = TRUE) %>%
      gsub(pattern = "\u00FC", replacement = "u", fixed = TRUE) %>%
      gsub(pattern = "\u00E8", replacement = "e", fixed = TRUE) %>%
      word(., -1)
  )
  all_cities <- rbind(all_cities, city)
}

# selecting only prices > 500 to get rid off most of wrong recorder data
# and weakly rents
all_cities <- all_cities[all_cities$price > 300,]

# Deleting rows where we have NA (about 16% of the data)
all_cities <- all_cities[complete.cases(all_cities),] 

# a <- all_cities[is.na(all_cities$rooms) & is.na(all_cities$m2),]
# 
# # ca ca marche mais c'est pas hyper propre...
# a <- all_cities[is.na(all_cities$rooms) == FALSE | is.na(all_cities$m2) == FALSE,]
```


#### Genereting map 

```{r}

# API key obtained with the test period (google)
#set_key("AIzaSyBQd93y1YsbrWKxMgnaRXoX0Wg6F-fiCqc")


#Create a df with raw information about the address coordinates
raw_coordinates <- google_geocode(address = "Via Monte Carmen 8 6900 Lugano")

#Create a df with only a column lng and a column ltd
coordinates_df <- raw_coordinates$results$geometry$location

#Using leaflet package to map the coordinates
leaflet() %>%
  addTiles() %>%  # Add default OpenStreetMap map tiles
  addMarkers(lng=8.953442, lat=46.01331, popup="The birthplace of R")

```



